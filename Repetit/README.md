# Repetit. Создание классификатора для определения неэффективных репетиторов

Заказчик: (`Repetit.ru`)[https://repetit.ru/], сервис по подбору репетиторов.<br>
Количество участников: более 50.<br>
Даты проведения: 11.03-10.04.2024.<br>

## Инструкция к репозиторию

* `Repetit_research.ipynb` - исследование с описанием разработки модели;
* `Repetit_functions.py` - файл с классом `Repetit`, в котором описаны основные функции, используемые в исследовании;
* `ТЗ Репетит.pdf` - ТЗ на выполнение проекта;
* `README.md` - краткое описание проекта.

## Описание проекта

Сервис **Repetit.ru** предоставляет площадку для подбора репетиторов по различным предметам. Сам сервис за свои услуги взимает комиссию, которая автоматически списывается после оплаты урока по специально ссылке. Но некоторые преподаватели предпочитают не платить комиссию, и, например, после нескольких уроков или сразу закрывают курс занятий и продолжают заниматься с учеником, взимая плату за уроки напрямую. Есть и другие способы мошенничества или обмана репетиторами платформы. Заказчику нужно как можно раньше понять, что репетитор недобросовестный или мошенник. Для этого заказчик предоставил данные по заявкам, занятиям, репетиторам и многие другие, в том числе и вручную размеченный датасет, в котором отмечены неэффективные и хорошие преподаватели. Ручная разметка происходила с помощью прозванивания клиентов и опроса на факт мошенничества или обмана.

Требования заказчика оформлены в ТЗ, там же есть описание признаков и потенциально важные критерии для выявления неэффективных преподавателей.
Так же отдельным вопросом стоит определение "неэффективности" преподавателей. После устного обсуждения заказчиком было установлено, что основным критерием является упущенная выгода заказчика, то есть отсутствие комиссии из-за оплаты занятий напрямую, а не по ссылке.

## Задача

Разработать модель для классификации учителей на платящих и неэффективных.
Метрика: **F1**.
После классификации преподавателей моделью, ответы будут вручную проверяться оператором, поэтому дополнительно применялась `recall` ориентированная метрика **Fbeta** с `beta=2`, для увеличения веса `false negative` и уменьшения вклада `false positive`.

## Лучшее решение

Лучшим решением признан `RandomForestClassifier`, включающий в себя предобработку данных с помощью `Pipeline`и обученный на признаках из `teachers.feather` и некоторых сгенерированных дополнительно. Достигнутое значение метрики `f1` на тестовой выборке : **0.6795**. Разработнный классификатор позволяет сократить время на ручную проверку на **55%**, упуская всего **21%** неэффективных преподавателей. Для сокращения объёма исследования значительная часть кода обёрнута в функции, которые вынесены в класс `Repetit`, расположенный в файл `Repetit_functions.py`.

## Исследование

Исследования начинается с **Подготовки к работе**, в которой подключены нужные библиотеки и созданный для проекта класс `Repetit`, который содержит в себе функции, используемые в исследовании. Такой подход позволяет сократить количество кода в большом исследовании и упростить деплой модели в докер контейнер в последующем.

В **Загрузке и обзоре данных** сделаны первые выводы по данным. В связи с большим количеством признаков было решено не использовать их все для обучения модели, а выбрать несколько потенциально важных признаков, которые должны помочь модели определить неэффективных преподавателей и создать несколько искусственных. Так же обнаружено огромное количество пропусков в `lessons.amount_paid`, то есть в информации о фактической оплате уроков: всего 8143 не пустых значения из 1191127, что составляет меньше процента. Для сравнения, вручную размечено 1656 преподавателей. То есть объём предоставленной информации составляет по 5 уроков в среднем. Это поставило под сомнение возможность эффективной генерации значимых признаков. На вопросы о природе пропусков и возможности их устранения заказчик не ответил.

Затем были **Созданы новые признаки** и обогащён ими изначальный датасет `teachers_df`. Основная идея генерации признаков взята из ТЗ - отобразить непостоянство преподавателей, так как у неэффективных преподавателей стоимости уроков отличаются.

После этого начался этап **Подготовки данных**.

Он начался с исследования признаков на корреляцию и удаление мультиколлинеарных признаков с помощью **DropCorrelatedFeatures**. Выявлено, что признаки, созданные на основе данных с большим количеством пропусков обладают высокой степенью корреляции. Далее методом **Isolation Forest** удалены выбросы, выбраны наиболее важные признаки с помощью **SelectKBest** и устранён дисбаланс методом **ADASYN**.

Рассмотренные в предыдущем пункте методы были объедены в **Pipeline**, при этом в классе `IsolationForest` был доопределён метод `fit_resample` для его передачи в `imblearn.pipeline`. Реализован мультискоринг с `f1` и `fbeta` и подбор гиперпараметров с `GridSearchCV`. Оценивались три классификатора: `LogisticRegression`, `RandomForestClassifier` и  `LGBMClassifier`. 

Для улучшения метрики реализован **StackingClassifier**, в который в качестве базовых моделей были добавлены три уже исследованных классификатора и ещё два более простых. Мета-модель: `LogisticRegression`.

По результатам **Тестирования лучших моделей** финальной моделью выбран `pipeline` на основе `RFC` со значением метрики **0.6795**.

На основе предсказаний финальной модели построена **Матрица ошибок**, рассмотренны и предложены два значения порога классификации. Показано, что разработнный классификатор позволяет сократить время на ручную проверку на **55%**, упуская всего **21%** неэффективных преподавателей.

Результаты работы описаны в **Выводах**.

## Используемые технологии

`EDA`, `генерация признаков`, `sklearn`, `DropCorrelatedFeatures`, `SelectKBest`, `ADASYN`, `Pipeline`, `GridSearchCV`, `lightgbm`, `StackingClassifier`.
